# Import Data & Necessary Packages

```{python}
import pandas as pd 
import numpy as np
```

```{python}
data = pd.read_csv('../data/synergy/run_expectancy.csv')
hr_data = pd.read_csv('../data/synergy/hr_expectancy.csv')
single_data = pd.read_csv('../data/synergy/1b_expectancy.csv')
double_data = pd.read_csv('../data/synergy/2b_expectancy.csv')
```

# Necessary Functions

```{python}
def summarize_bases(row):
    '''returns base number if player is on said base, else '''
    return (f"{'1' if row['on_1b'] else '_'}"
            f"{'2' if row['on_2b'] else '_'}"
            f"{'3' if row['on_3b'] else '_'}")

def get_table(data):
    '''return expectancy table for specific data frame'''
    exp_table = data.groupby(['outs', 'base_state'])
    exp_table = exp_table['runs'].mean().reset_index()
    exp_table = exp_table.pivot_table(
                    index = 'base_state', 
                    columns = 'outs', 
                    values = 'runs', 
                    aggfunc = 'mean')

    return exp_table.fillna(0)

def start_re(table, data, run_exp):
    '''return starting run expectancy for event'''
    event_re = table.multiply(run_exp).fillna(0)
    event_re = event_re.values.sum() / len(data)

    return event_re.round(3)
```

# Run Expectancies

## Overall Run Expectancy

```{python}
# summarize data for runners on base 
data['base_state'] = data.apply(summarize_bases, axis = 1)

# group by combinations of outs and runners on base
run_expectancy = data.groupby(['outs', 'base_state'])

# return to data frame structure
run_expectancy = run_expectancy['runs_scored'].mean().reset_index()

# pivot such that outs are columns
run_exp = run_expectancy.pivot_table(
            index = 'base_state', 
            columns = 'outs', 
            values = 'runs_scored', 
            aggfunc = 'mean')

# format numbers to three decimal places
pd.options.display.float_format = '{:.3f}'.format

run_exp
```

# Homerun

```{python}
# average run expectancy for homeruns
hr_avg = sum(hr_data['runs']) / len(hr_data)

# get expectancy table
hr_exp_table = get_table(hr_data)

# get starting home run expectancy
hr_start_re = start_re(hr_exp_table, hr_data, run_exp)

# final hr run expectancy
hr_re = hr_avg - hr_start_re

hr_re
```

## Single

```{python}
# average run expectancy for homeruns
single_avg = sum(single_data['runs']) / len(single_data)

# get expectancy table
single_exp_table = get_table(single_data)

# get starting home run expectancy
single_start_re = start_re(single_exp_table, single_data, run_exp)

# final hr run expectancy
single_re = single_avg - single_start_re

single_re
```

## Double

```{python}
# average run expectancy for homeruns
double_avg = sum(double_data['runs']) / len(double_data)

# get expectancy table
double_exp_table = get_table(double_data)

# get starting home run expectancy
double_start_re = start_re(double_exp_table, double_data, run_exp)

# final hr run expectancy
double_re = double_avg - double_start_re

double_re
```